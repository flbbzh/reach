<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
	<!-- Materialize -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
	<!-- Flexible Datasync -->
	<script src="https://datasync.orange.com/libjs/latest/webcom.js"></script>
	<!-- Reach -->
	<script src="../dist/reach-debug.js"></script>
	<!-- Tester -->
	<script type="text/javascript">
		var format = function(tpl) {
			var values = [].slice.call(arguments, 1);
			return tpl.replace(
				new RegExp('{([0-' + (values.length - 1 ) + '])}','g'),
				function (match, index) {
					return values[index];
				}
			);
		};

		// Use the same user
		var localEmail = localStorage.getItem('reachtest:mail');
		if(!localEmail && Reach.browser.compatible) {
			var os;
			if(/android/i.test(navigator.userAgent)) {
				os = /android\s[0-9\.]+/i.exec(navigator.userAgent)[0].toLowerCase().replace(/[\s\.]/g, '_');
			} else if(/iphone/i.test(navigator.userAgent)){
				os = 'ios'
			} else if(/mac\sos\sx/i.test(navigator.userAgent)) {
				os = 'osx';
			} else if(/linux/i.test(navigator.userAgent)) {
				os = 'linux';
			} else {
				os = 'win';
			}
			localEmail = format('{0}.{1}.{2}@reach.io', Reach.browser.browser, Reach.browser.version, os);
			localStorage.setItem('reachtest:mail', localEmail);
		}

		var modalError = function(title, message) {
			var dialog = $('#errorDialog');
			dialog.find('h4').text(title);
			dialog.find('p').text(message);
			dialog.openModal();
		};

		$(document).ready(function(){
			if(!Reach.browser.compatible){
				modalError('Incompatible browser', JSON.stringify(Reach.browser));
			} else {
				$('#current').show();
				window.reachtest = new Reach('https://io.datasync.orange.com/base/reachtest', {
					preferredAudioCodec: Reach.codecs.audio.OPUS,
					preferredVideoCodec: Reach.codecs.video.VP9,
					remoteStreamContainer: $('#remoteVideo')[0],
					localStreamContainer: $('#localVideo')[0],
					logLevel: 'DEBUG',
					constraints: Reach.media.constraints()
				});
			}
		});

		var user = {
			add: function(u) {
				if(u.uid != reachtest.current.uid && /reach.io$/.test(u.name) && !$(format('tr[data-userId={0}]', u.uid)).length) {
					$('#users_list').append(
						format(
							'<tr data-userId="{0}"><td>{1}</td><td>{2}</td><td>{3}</td><td><a class="waves-effect waves-light btn">invite</a></td></tr>',
							u.uid, u.name, u.status, new Date(u.lastSeen)
						)
					);
					var bt = $('#users_list').find(format('tr[data-userId={0}] a', u.uid));
					bt.toggleClass('disabled', /^DISCONNECTED$/.test(u.status) || /^NOT_CONNECTED$/.test(u.status));
					bt.click(function(e) {
						if(!$(e.target).hasClass('disabled') && !window._room) {
							u.invite()
								.then(function (d) {
									window._room = d.room;
									room.join();
								});
						}
					});
				}
			},
			update: function(u) {
				if(u.uid && $('#users_list').find(format('tr[data-userId={0}]', u.uid)).length === 1) {
					var tds = $('#users_list').find(format('tr[data-userId={0}] td', u.uid));
					$(tds[0]).text(u.name);
					$(tds[1]).text(u.status);
					$('#users_list').find(format('tr[data-userId={0}] a', u.uid)).toggleClass('disabled', /^DISCONNECTED$/.test(u.status) || /^NOT_CONNECTED$/.test(u.status))
				}
			},
			remove: function(u) {
				u.uid && $('#users_list').find(format('tr[data-userId={0}]', u.uid)).remove();
			}
		};

		var invite = {
			add: function(i) {
				if(i.isOnGoing && !window._room) {
					i.accept()
						.then(function (d) {
							Materialize.toast(format('Invite from {0} to room {1} accepted', i.from, i.room), 3000);
							window._room = d.room;
							return room.join();
						})
						.catch(function(e) {
							console.error(e);
							window._room = null;
						});
				} else if(i.isOnGoing) {
					i.reject()
						.then(function () {
							Materialize.toast(format('Invite from {0} to room {1} has been rejected', i.from, i.room), 3000);
						})
				} else {
					// Old invite
					reachtest.base.child(format('_/invites/{0}/{1}', reachtest.current.uid, + i.uid)).remove();
				}
			}
		};

		var room = {
			join: function() {
			   window._room.join()
					.then(function(_room) {
						$('#users').hide();
						var roomNode = $('#room');
						roomNode.find('table tbody').empty();
						Object.keys(_room)
							.filter(function(key){
								return !/^extra$/.test(key) && !/^_callbacks/.test(key);
							})
							.forEach(function(key) {
								$("#roomMeta").append(format('<tr><td>{0}</td><td>{1}</td></tr>', key, _room[key]));
							});
						roomNode.show();
						_room.on(Reach.events.room.STREAM_PUBLISHED, function (remoteStream) {
							if(remoteStream.from !== reachtest.current.uid) {
								window._remoteStream = remoteStream;
								stream.subscribe();

							}
						});
						_room.on(Reach.events.room.STREAM_UNPUBLISHED, function(stream) {
							if(stream.uid === window._remoteStream.uid) {
								$('#remote').hide();
								window._remoteStream = null;
							}
						});
						_room.on(Reach.events.room.PARTICIPANT_ADDED, function(participant) {
							var userName = participant.uid === reachtest.current.uid ? localEmail : $('#users_list').find(format('tr[data-userId={0}] td:first-child', participant.uid)).text();
							$("#participants").append(
								format(
									'<tr data-userId="{0}"><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td></tr>',
									participant.uid, userName, participant.role || 'NONE', new Date(participant._joined), participant.status
								)
							);
						});
						_room.on(Reach.events.room.PARTICIPANT_CHANGED, function(participant) {
							var userName = $('#users_list').find(format('tr[data-userId={0}] td:first-child', participant.uid)).text();
							$("#participants")
								.find(format('tr[data-userId={0}]', participant.uid))
								.replaceWith(
									format(
										'<tr data-userId="{0}"><td>{1}</td><td>{2}</td><td>{3}</td><td>{4}</td></tr>',
										participant.uid, userName, participant.role || 'NONE', new Date(participant._joined), participant.status
									)
								);
						});
						_room.on(Reach.events.room.PARTICIPANT_REMOVED, function(participant) {
							$("#participants").find(format('tr[data-userId={0}]', participant.uid)).remove();
							room._leave();
						});
					});
			},
			_leave: function() {
				window._room && window._room.leave().then(function () {
					$('#users').show();
					$('#local').hide();
					$('#remote').hide();
					$('#room').hide();
					$('#share_bts').find('').toggleClass('disabled', false);
					window._room = null;
				});
			},
			leave: function(btn) {
				if(!$(btn).hasClass('disabled')) {
					room._leave();
				}
			},
			publish: function(btn, type) {
				if(!$(btn).hasClass('disabled')) {
					window._room.share(type)
						.then(function(localStream) {
							window._localStream = localStream;
							$('#local').show();
							$('#share_bts').find('a').toggleClass('disabled', true);
							$('#audio_bt').toggle(/audio/i.test(type));
							$('#video_bt').toggle(/video/i.test(type));
							stream.muteLocalStatus(localStream.muted);
							Reach.media.devices()
								.then(function(devices){
									Object.keys(devices).forEach(function(kind) {
										if(/input$/.test(kind)) {
											var node = $('#' + kind);
											node.empty();
											devices[kind].forEach(function(device) {
												node.append(format(
													'<li><a href="#!" data-deviceId="{0}" style="max-width:15em">{1}</a></li>', device.deviceId, device.label || device.deviceId
												));
											});
											node.find('a[data-deviceId]').click(function(){
												window._localStream && window._localStream[kind === 'audioinput' ? 'switchMicrophone' : 'switchCamera']($(this).attr('data-deviceId'));
											})
										}
									});
								});
						})
						.catch(function(e){
							modalError('Publish fail', e.message);
							console.error('Publish fail', e);
						});
				}
			}
		};

		var stream = {
			switchCamera: function(btn, id){
				!$(btn).hasClass('disabled') && window._localStream && window._localStream.switchCamera(id);
			},
			switchMic: function(id){
				!$(btn).hasClass('disabled') && window._localStream && window._localStream.switchMicrophone(id);
			},
			close: function(){
				window._localStream && window._localStream.close();
				$('#local').hide();
				$('#share_bts').find('a').toggleClass('disabled', false);
			},
			muteStatus: function(status) {
				$('#video_mute').toggle(status.video);
				$('#audio_mute').toggle(status.audio);
			},
			muteLocalStatus: function(status) {
				$('#mute_video').toggle(!status.video);
				$('#unmute_video').toggle(status.video);
				$('#mute_audio').toggle(!status.audio);
				$('#unmute_audio').toggle(status.audio);
			},
			remoteBtns: function(subscribed) {
				var remote = $('#remote');
				remote.find('.col:first-child a').toggleClass('disabled', !subscribed);
				remote.find('.col.s4 a:first-child').toggleClass('disabled', !subscribed);
				remote.find('.col.s4 a:last-child').toggleClass('disabled', subscribed)
			},
			subscribe: function(btn) {
				if(!$(btn).hasClass('disabled') && window._remoteStream) {
					window._remoteStream.on(Reach.events.stream.MUTE, stream.muteStatus);
					window._remoteStream.subscribe()
						.then(function(){
							$('#remote').show();
							stream.muteStatus(window._remoteStream.muted);
							stream.remoteBtns(true);
						});
				}
			},
			unSubscribe: function(btn) {
				if(!$(btn).hasClass('disabled') && window._remoteStream) {
					window._remoteStream.off();
					window._remoteStream.unSubscribe();
					stream.remoteBtns(false);
				}
			},
			mute: function(btn, type, value){
				if(!$(btn).hasClass('disabled') && window._localStream) {
					window._localStream.mute(type, value);
					stream.muteLocalStatus(window._localStream.muted);
				}
			},
			localStats: function(btn){
				if(!$(btn).hasClass('disabled') && window._localStream && window._localStream.peerConnections.length) {
					stream.stats('Local stats', window._localStream.peerConnections[0].pc)
				}
			},
			remoteStats: function(btn){
				if(!$(btn).hasClass('disabled') && window._remoteStream && window._remoteStream.peerConnection) {
					stream.stats('Remote stats', window._remoteStream.peerConnection.pc)
				}
			},
			stats: function(title, peerCo) {
				peerCo.getStats()
					.then(function(stats) {
						var statsDialog = $('#statsDialog');
						statsDialog.find('h4').text(title);
						statsDialog.find('ul').empty();
						var values = stats.values(), next = values.next();
						while(!next.done) {
							var li = document.createElement('li');
							$(li).append(format('<div class="collapsible-header truncate">{0}</div>', next.value.id));
							$(li).append('<div class="collapsible-body"><table class="striped"><tbody></tbody></table></div>');
							Object.keys(next.value).forEach(function(key) {
								$(li).find('tbody').append(format('<tr><td>{0}</td><td class="truncate">{1}</td></tr>', key, next.value[key]));
							});
							statsDialog.find('ul').append(li);
							next = values.next();
						}
						statsDialog.openModal();
					})
			}

		};

		var login = function(btn){
			if(!$(btn).hasClass('disabled')) {
				var previousId = localStorage.getItem('reachtest:uid');
				reachtest.login(localEmail, 'Passwd123', localEmail)
					.catch(
						function(e) {
							if(/INVALID_USER/i.test(e.code)) {
								return reachtest.register(localEmail, 'Passwd123');
							}
							return Promise.reject(e);
						}
					)
					.then(function(){
						$('#current').find('a').toggleClass('disabled');
						$('#users').show();
						room.leave();
						reachtest.on(Reach.events.reach.INVITE_ADDED, invite.add);
						reachtest.on(Reach.events.reach.USER_ADDED, user.add);
						reachtest.on(Reach.events.reach.USER_CHANGED, user.update);
						reachtest.on(Reach.events.reach.USER_REMOVED, user.remove);
						if(previousId !== reachtest.current.uid) {
							localStorage.setItem('reachtest:uid', reachtest.current.uid);
							reachtest.base.child('/users/' + previousId).remove();
							reachtest.base.child('/_/invite/' + previousId).remove();
							reachtest.base.child('/_/devices/' + previousId).remove();
							Webcom.INTERNAL.PersistentStorage.remove(previousId);
						}
					});
			}
		};

		var logout = function(btn) {
			if(!$(btn).hasClass('disabled')) {
				reachtest.logout()
					.then(function(){
						$('#users').hide();
						$('#users_list').empty();
						$('#current').find('a').toggleClass('disabled');
						$('#local').hide();
						$('#room').hide();
						$('#remote').hide()
					});
			}
		}
	</script>
	<style>
		video {
			position: relative;
			max-width: 100%;
		}
	</style>
</head>
<body>

<div id="errorDialog" class="modal">
	<div class="modal-content">
		<h4>Error</h4>
		<p></p>
	</div>
	<div class="modal-footer">
		<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">ok</a>
	</div>
</div>

<div id="statsDialog" class="modal modal-fixed-footer">
	<div class="modal-content">
		<h4>Stats</h4>
		<ul class="collapsible"></ul>
	</div>
	<div class="modal-footer">
		<a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">close</a>
	</div>
</div>

<div class="row">
	<div class="col s12" id="current" style="display:none">
		<div class="card">
			<div class="card-content">
				<span class="card-title">Local User: <script>document.write(localEmail);</script></span>
			</div>
			<div class="card-action">
				<a class="waves-effect waves-light btn" onclick="window.login(this)">login</a>
				<a class="waves-effect waves-light btn disabled" onclick="window.logout(this)">logout</a>
			</div>
		</div>
	</div>
	<div class="col s12" id="users" style="display:none">
		<div class="card">
			<div class="card-content">
				<span class="card-title">Connected Users</span>
				<table class="striped">
					<thead>
						<th data-field="name">Name</th>
						<th data-field="status">Status</th>
						<th data-field="lastSeen">Last Seen</th>
					</thead>
					<tbody id="users_list"></tbody>
				</table>
			</div>
		</div>
	</div>
	<div class="col s12" id="room" style="display:none">
		<div class="card">
			<div class="card-content">
				<div class="row">
					<div class="col s12 m12 l6">
						<span class="card-title">Room</span>
						<table class="striped">
							<thead>
								<tr>
									<th>Property</th>
									<th>Value</th>
								</tr>
							</thead>
							<tbody id="roomMeta"></tbody>
						</table>
					</div>
					<div class="col s12 m12 l6">
						<span class="card-title">Participants</span>
						<table class="striped" >
							<thead>
								<tr>
									<th>Name</th>
									<th>Role</th>
									<th>Last Seen</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody id="participants"></tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="card-action">
				<div class="row">
					<div class="col s2">
						<a class="waves-effect waves-light btn-floating blue" onclick="room.leave(this)" title="Leave room"><i class="material-icons">power_settings_new</i></a>
					</div>
					<div class="col s4" id="share_bts">
						<a class="waves-effect waves-light btn-floating cyan" onclick="room.publish(this, Reach.types.AUDIO_VIDEO)" title="Share audio & video"><i class="material-icons">perm_camera_mic</i></a>
						<a class="waves-effect waves-light btn-floating blue-grey" onclick="room.publish(this, Reach.types.AUDIO)" title="Share audio"><i class="material-icons">mic</i></a>
						<a class="waves-effect waves-light btn-floating green" onclick="room.publish(this, Reach.types.VIDEO)" title="Share video"><i class="material-icons">videocam</i></a>
					</div>
					<div class="col s6"></div>
				</div>
			</div>
		</div>
	</div>
	<div class="col s12 m12 l6" id="local" style="display:none">
		<div class="card">
			<div class="card-content">
				<span class="card-title">Local Stream</span>
				<div id="localVideo"></div>
			</div>
			<div class="card-action" >
				<div class="row">
					<div class="col s2">
						<a class="waves-effect waves-light btn-floating blue" onclick="stream.localStats(this)" title="stats"><i class="material-icons">trending_up</i></a>
					</div>
					<div class="col s2">
						<a class="waves-effect waves-light btn-floating red" onclick="stream.close(this)" title="close"><i class="material-icons">call_end</i></a>
					</div>
					<div class="col s4" id="video_bt">
						<a class="waves-effect waves-light btn-floating green" id="mute_video" onclick="stream.mute(this, 'video')"><i class="material-icons">videocam_off</i></a>
						<a class="waves-effect waves-light btn-floating green" id="unmute_video" onclick="stream.mute(this, 'video', false)"><i class="material-icons">videocam</i></a>
						<a class="waves-effect waves-light btn-floating green" onclick="stream.switchCamera(this)" title="Switch camera"><i class="material-icons left">loop</i></a>
						<a class='dropdown-button btn-floating green' href='#' data-activates='videoinput' data-constrainwidth='false'><i class="material-icons left">list</i></a>
						<ul id='videoinput' class='dropdown-content'></ul>
					</div>
					<div class="col s4" id="audio_bt">
						<a class="waves-effect waves-light btn-floating blue-grey" id="mute_audio" onclick="stream.mute(this, 'audio')"><i class="material-icons">mic_off</i></a>
						<a class="waves-effect waves-light btn-floating blue-grey" id="unmute_audio" onclick="stream.mute(this, 'audio', false)"><i class="material-icons">mic</i></a>
						<a class="waves-effect waves-light btn-floating blue-grey" onclick="stream.switchMic(this)" title="Switch Microphone"><i class="material-icons left">loop</i></a>
						<a class='dropdown-button btn-floating blue-grey' href='#' data-activates='audioinput' data-constrainwidth='false'><i class="material-icons left">list</i></a>
						<ul id='audioinput' class='dropdown-content'></ul>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col s12 m12 l6" id="remote" style="display:none">
		<div class="card">
			<div class="card-content">
				<span class="card-title">Remote Stream</span>
				<div id="remoteVideo"></div>
			</div>
			<div class="card-action">
				<div class="row">
					<div class="col s2">
						<a class="waves-effect waves-light btn-floating blue" onclick="stream.remoteStats(this)" title="stats"><i class="material-icons">trending_up</i></a>
					</div>
					<div class="col s4">
						<a class="waves-effect waves-light btn-floating red" onclick="stream.unSubscribe(this)" title="unsubscribe"><i class="material-icons">call_end</i></a>
						<a class="waves-effect waves-light btn-floating green" onclick="stream.subscribe(this)" title="re-subscribe"><i class="material-icons">call</i></a>
					</div>
					<div class="col s2" id="video_status">
						<a class="btn-floating disabled" id="video_mute" style="display:none"><i class="material-icons">videocam_off</i></a>
					</div>
					<div class="col s2" id="audio_status">
						<a class="btn-floating disabled" id="audio_mute" style="display:none"><i class="material-icons">mic_off</i></a>
					</div>
					<div class="col s2"></div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>
